#!/bin/bash -e

. settings

REMOTE_BRANCH=rpm/$VERSION

cd "$PACKAGING_DIR"

git fetch $PACKAGING_GIT_REMOTE
git checkout -b rpm/release-$FULLVERSION $PACKAGING_GIT_REMOTE/$REMOTE_BRANCH

for package in $RPM_PACKAGES ; do
	(

		if [[ $FULLVERSION == *-RC* ]] ; then
			if [[ FULLVERSION == *-RC1 ]] ; then
				echo "TODO: bump release"
			fi
			obal update $package -e version=${FULLVERSION%%-RC*} -e prerelease=${FULLVERSION##*-}
		else
			obal update $package -e version=$FULLVERSION
		fi
	)
done

if [[ $PACKAGING_PR == true ]] ; then
	git phr -m "Release $FULLVERSION" -b "$REMOTE_BRANCH"
else
	git push $PACKAGING_GIT_REMOTE HEAD:$REMOTE_BRANCH
fi
